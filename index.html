<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Semanal de Sesiones</title>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="app-header">
    <div class="header-brand">
      <h1>Panel de Productividad</h1>
    </div>
    <div class="header-controls">
      <div class="week-controls">
        <button id="prev-week" class="btn-ghost" title="Semana anterior">◀</button>
        <input id="week-picker" type="date" />
        <button id="next-week" class="btn-ghost" title="Semana siguiente">▶</button>
        <button id="today-week" class="btn-ghost">Semana actual</button>
      </div>
      <div class="auth-controls">
        <button id="signin" class="btn-primary">Conectar Google Calendar</button>
        <span id="gc-status" class="badge muted" role="status" aria-live="polite">Sin conexión</span>
        <button id="refresh" class="btn-ghost" title="Volver a cargar">↻</button>
      </div>
    </div>
  </header>

  <div id="loading-indicator" class="loading-indicator hidden">
    <div class="label"><span class="spinner"></span> Cargando…</div>
  </div>

  <main class="app-main">
    <nav class="view-tabs main-tabs" data-role="primary" aria-label="Secciones del panel" role="tablist">
      <button class="tab active" type="button" role="tab" tabindex="0" aria-selected="true" aria-controls="panel-resumenes" data-view="resumenes">Resúmenes</button>
      <button class="tab" type="button" role="tab" tabindex="-1" aria-selected="false" aria-controls="panel-pacientes" data-view="pacientes">Pacientes</button>
      <button class="tab" type="button" role="tab" tabindex="-1" aria-selected="false" aria-controls="panel-ajustes" data-view="ajustes">Ajustes</button>
    </nav>

    <section class="view-panel active" id="panel-resumenes" role="tabpanel" data-view="resumenes">
      <div class="panel-inner">
        <section class="card summary-card">
          <div class="summary-header">
            <div>
              <h2>Resumen de productividad</h2>
              <span class="tag" id="week-label">Semana actual</span>
            </div>
            <div class="summary-actions">
              <button id="quick-report" class="btn-ghost accent-ring" type="button">Informe rápido</button>
            </div>
          </div>

          <div class="summary-switcher">
            <div class="view-tabs summary-tabs" data-role="summary" role="tablist" aria-label="Cambiar periodo del resumen">
              <button class="tab active" id="summary-tab-semana" type="button" role="tab" tabindex="0" aria-selected="true" aria-controls="kpi-panel-semana" data-view="semana">Semana</button>
              <button class="tab" id="summary-tab-mes" type="button" role="tab" tabindex="-1" aria-selected="false" aria-controls="kpi-panel-mes" data-view="mes">Mes</button>
              <button class="tab" id="summary-tab-ano" type="button" role="tab" tabindex="-1" aria-selected="false" aria-controls="kpi-panel-ano" data-view="ano">Año</button>
            </div>
          </div>

          <div class="summary-panels">
            <article class="panel kpi-panel active" id="kpi-panel-semana" role="tabpanel" aria-labelledby="summary-tab-semana" data-view="semana">
              <header>
                <h3>Semana</h3>
                <span class="muted">Detalle operativo</span>
              </header>
              <div class="stat-grid" id="stats">
                <article class="stat">
                  <span class="label">Sesiones impartidas (45')</span>
                  <span class="value" id="stat-dadas">–</span>
                  <span class="stat-subtext" id="stat-en-curso">En curso: –</span>
                </article>
                <article class="stat">
                  <span class="label">Programadas</span>
                  <span class="value" id="stat-programadas">–</span>
                </article>
                <article class="stat">
                  <span class="label">Sesiones totales (dadas + programadas + en curso)</span>
                  <span class="value" id="stat-week-total">–</span>
                </article>
                <article class="stat">
                  <span class="label">Ausencias</span>
                  <span class="value" id="stat-ausencias">–</span>
                </article>
                <article class="stat">
                  <span class="label">% sesiones impartidas</span>
                  <span class="value percent" id="stat-week-pct">–</span>
                  <span class="delta hidden" id="stat-week-delta"></span>
                  <span class="stat-subtext">Objetivo: 80%</span>
                  <span class="stat-subtext" id="stat-week-shortfall">Faltan — para alcanzar el objetivo</span>
                </article>
                <article class="stat forecast">
                  <span class="label">Previsión % con programadas</span>
                  <span class="value percent" id="stat-week-forecast">–</span>
                  <span class="stat-subtext">Incluye programadas y en curso</span>
                </article>
              </div>
              <div class="stat-grid compact">
                <article class="stat">
                  <span class="label">CAIT Gines</span>
                  <span class="value" id="stat-gines">–</span>
                </article>
                <article class="stat">
                  <span class="label">CAIT Bormujos</span>
                  <span class="value" id="stat-bormujos">–</span>
                </article>
                <article class="stat">
                  <span class="label">Privado</span>
                  <span class="value" id="stat-privado">–</span>
                  <span class="stat-subtext" id="stat-privado-just">Ausencias just.: –</span>
                  <span class="stat-subtext" id="stat-privado-nojust">Ausencias no just.: –</span>
                </article>
              </div>
            </article>

            <article class="panel kpi-panel" id="kpi-panel-mes" role="tabpanel" aria-hidden="true" aria-labelledby="summary-tab-mes" data-view="mes">
              <header>
                <h3>Mes</h3>
                <span class="muted" id="month-hours-label">—</span>
              </header>
              <div class="stat-grid compact" id="month-stats">
                <article class="stat">
                  <span class="label">Sesiones impartidas</span>
                  <span class="value" id="stat-month-dadas">–</span>
                </article>
                <article class="stat">
                  <span class="label">Ausencias</span>
                  <span class="value" id="stat-month-ausencias">–</span>
                </article>
                <article class="stat">
                  <span class="label">Privado ausencias (just. / no just.)</span>
                  <span class="value" id="stat-month-privado-abs">–</span>
                </article>
                <article class="stat">
                  <span class="label">Programadas</span>
                  <span class="value" id="stat-month-programadas">–</span>
                </article>
                <article class="stat">
                  <span class="label">Sesiones totales (dadas + programadas + en curso)</span>
                  <span class="value" id="stat-month-total">–</span>
                </article>
                <article class="stat">
                  <span class="label">% sesiones impartidas</span>
                  <span class="value percent" id="stat-month-pct">–</span>
                  <span class="delta hidden" id="stat-month-delta"></span>
                  <span class="stat-subtext">Objetivo: 80%</span>
                  <span class="stat-subtext" id="stat-month-shortfalls">Semana: faltan <span id="stat-month-week-missing">—</span> · Mes: faltan <span id="stat-month-missing">—</span></span>
                </article>
                <article class="stat forecast">
                  <span class="label">Previsión % con programadas</span>
                  <span class="value percent" id="stat-month-forecast">–</span>
                  <span class="stat-subtext">Incluye programadas y en curso</span>
                </article>
              </div>
              <p class="muted" id="month-label">—</p>
            </article>

            <article class="panel kpi-panel" id="kpi-panel-ano" role="tabpanel" aria-hidden="true" aria-labelledby="summary-tab-ano" data-view="ano">
              <header>
                <h3>Año</h3>
                <span class="muted" id="year-hours-label">—</span>
              </header>
              <div class="stat-grid compact" id="year-stats">
                <article class="stat">
                  <span class="label">Sesiones impartidas</span>
                  <span class="value" id="stat-year-dadas">–</span>
                </article>
                <article class="stat">
                  <span class="label">Ausencias</span>
                  <span class="value" id="stat-year-ausencias">–</span>
                </article>
                <article class="stat">
                  <span class="label">Privado ausencias (just. / no just.)</span>
                  <span class="value" id="stat-year-privado-abs">–</span>
                </article>
                <article class="stat">
                  <span class="label">Programadas</span>
                  <span class="value" id="stat-year-programadas">–</span>
                </article>
                <article class="stat">
                  <span class="label">% sesiones impartidas</span>
                  <span class="value percent" id="stat-year-pct">–</span>
                  <span class="delta hidden" id="stat-year-delta"></span>
                  <span class="stat-subtext">Objetivo: 80%</span>
                  <span class="stat-subtext" id="stat-year-shortfall">Faltan — para alcanzar el objetivo</span>
                </article>
                <article class="stat forecast">
                  <span class="label">Previsión % con programadas</span>
                  <span class="value percent" id="stat-year-forecast">–</span>
                  <span class="stat-subtext">Incluye programadas y en curso</span>
                </article>
              </div>
              <p class="muted" id="year-label">—</p>
            </article>
          </div>
        </section>
      </div>
    </section>

    <section class="view-panel" id="panel-pacientes" role="tabpanel" aria-hidden="true" data-view="pacientes">
      <div class="panel-inner">
        <section class="card events-card">
          <div class="section-heading">
            <div>
              <h2>Eventos de la semana</h2>
              <p class="muted" id="range-label">—</p>
            </div>
            <div class="row compact">
              <select id="calendar-select"></select>
              <button id="load-week">Actualizar semana</button>
            </div>
          </div>

          <div class="legend">
            <div>
              <span class="legend-title">Estados</span>
              <div class="legend-group">
                <span class="legend-item"><span class="legend-dot green"></span>Dada</span>
                <span class="legend-item"><span class="legend-dot yellow"></span>Programada</span>
                <span class="legend-item"><span class="legend-dot blue"></span>En curso</span>
                <span class="legend-item"><span class="legend-dot red"></span>Ausencia</span>
                <span class="legend-item"><span class="legend-dot gray"></span>Otros</span>
              </div>
            </div>
            <div>
              <span class="legend-title">Centros</span>
              <div class="legend-group">
                <span class="legend-item"><span class="legend-dot green"></span>Gines</span>
                <span class="legend-item"><span class="legend-dot orange"></span>Bormujos</span>
                <span class="legend-item"><span class="legend-dot purple"></span>Privado</span>
              </div>
            </div>
          </div>

          <div class="filters-panel">
            <div>
              <span class="muted">Filtrar por estado</span>
              <div class="chip-group" id="status-filters">
                <button class="chip" data-key="dada">Dadas</button>
                <button class="chip" data-key="programada">Programadas</button>
                <button class="chip" data-key="ausencia">Ausencias</button>
                <button class="chip" data-key="otro">Otros</button>
              </div>
            </div>
            <div>
              <span class="muted">Filtrar por centro</span>
              <div class="chip-group" id="center-filters">
                <button class="chip" data-key="gines">Gines</button>
                <button class="chip" data-key="bormujos">Bormujos</button>
                <button class="chip" data-key="privado">Privado</button>
              </div>
            </div>
            <div class="table-actions">
              <button id="export-csv" class="btn-ghost">Exportar CSV</button>
              <button id="print-view" class="btn-ghost">Imprimir vista</button>
            </div>
          </div>

          <div class="stat-grid compact narrative-stats">
            <article class="stat">
              <span class="label">Recuperaciones</span>
              <span class="value" id="stat-week-recuperacion">0</span>
            </article>
            <article class="stat">
              <span class="label">Menciones a "entorno"</span>
              <span class="value" id="stat-week-entorno">0</span>
            </article>
            <article class="stat">
              <span class="label">Menciones a "familia"</span>
              <span class="value" id="stat-week-familia">0</span>
            </article>
          </div>

          <div class="table-container">
            <table id="events-table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Inicio</th>
                  <th>Fin</th>
                  <th>Título</th>
                  <th>Centro</th>
                  <th>Estado</th>
                  <th>Tipo</th>
                  <th>Duración</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
    </section>

    <section class="view-panel" id="panel-ajustes" role="tabpanel" aria-hidden="true" data-view="ajustes">
      <div class="panel-inner">
        <section class="card settings-card">
          <div class="onboarding-card">
            <div class="onboarding-header">
              <div>
                <p class="muted eyebrow">Para empezar</p>
                <h2>Guía rápida para nuevos usuarios</h2>
              </div>
              <span class="tag">Nuevo</span>
            </div>
            <div class="onboarding-grid">
              <article>
                <h3>Sesiones en Google Calendar</h3>
                <p class="muted">El título debe seguir el formato para que el panel lo lea correctamente:</p>
                <p class="example">1234 Nombre Apellidos (G/B/P)</p>
                <p class="muted">Usa <strong>(G)</strong> Gines, <strong>(B)</strong> Bormujos o <strong>(P)</strong> Privado.</p>
              </article>
              <article>
                <h3>Ausencias justificadas vs no justificadas</h3>
                <p class="muted">Añade un <strong>*</strong> al inicio del título para marcar una ausencia.</p>
                <p class="muted">Si es privado y está justificada, incluye palabras como <em>justificada</em> en la descripción.</p>
                <p class="muted">Si no indicas justificación, el sistema la contará como sesión dada.</p>
              </article>
              <article>
                <h3>Festivos, vacaciones y bajas</h3>
                <p class="muted">Crea un evento de día completo con “festivo”, “vacaciones” o “baja”.</p>
                <p class="muted">Estos eventos descuentan horas disponibles automáticamente.</p>
              </article>
              <article>
                <h3>Horas de jornada</h3>
                <p class="muted">Define tus horas semanales en <strong>Horas de jornada semanal</strong>.</p>
                <p class="muted">Esto ajusta la barra de ocupación y los objetivos de productividad.</p>
              </article>
            </div>
          </div>
          <h2>Preferencias rápidas</h2>
          <div class="form-group">
            <label class="muted" for="cfg-hours">Horas de jornada semanal</label>
            <div class="row compact">
              <select id="cfg-hours-mode" aria-label="Modo de cálculo de jornada">
                <option value="fixed">Jornada fija (ajustes)</option>
                <option value="effective_schedule">Horario efectivo (bloques)</option>
              </select>
              <input id="cfg-hours" type="number" min="0" step="0.25" value="38.5" />
              <button id="save-cfg">Guardar</button>
            </div>
            <p class="muted help-text">Modo fijo: usa las horas semanales que indiques aquí. Modo horario efectivo: calcula las horas disponibles según la suma de bloques del calendario (B4/G10/Gines 4/Bormujos 10, etc.).</p>
          </div>

          <div class="form-group">
            <div class="section-header" style="margin-bottom:8px">
              <h3>Reglas personalizadas</h3>
              <button id="reset-rules" class="btn-ghost" type="button">Restablecer</button>
            </div>
            <p class="muted help-text">Edita cómo se clasifican los eventos, centros y ausencias. El formato es JSON editable.</p>
            <pre class="rules-editor"><code id="rules-json" contenteditable="true">{
  "centros": {
    "gines": ["(g)"],
    "bormujos": ["(b)"],
    "privado": ["(p)"]
  },
  "pattern_sesion": "^\\*?\\s*(\\d{3,6})\\s+(.+?)\\s*\\(([BGP])\\)\\s*$",
  "otros_excluir_totalmente": [
    "^g\\s*:\\s*\\d+$",
    "^b\\s*:\\s*\\d+$",
    "^ent\\.\\s*[bg]\\s*:\\s*\\d+"
  ],
  "bloques_horario": [
    "^(?:[bg]\\s*\\d{1,2}|(?:gines|bormujos)\\s*\\d{1,2})$"
  ],
  "otros_keywords": [
    "firma",
    "comida",
    "coordinación",
    "reunión",
    "formación",
    "llamada",
    "administrativo",
    "battelle"
  ],
  "ausencias_descuentan": [
    "festivo",
    "vacaciones",
    "baja"
  ]
}</code></pre>
            <div class="row compact" style="margin-top:8px">
              <button id="save-rules">Guardar reglas</button>
            </div>
            <p class="muted help-text">Usa <strong>*</strong> al inicio del título para marcar una ausencia. Para descontar horas, crea un evento de día completo cuyo título incluya una palabra de <code>ausencias_descuentan</code> (ej. festivo, vacaciones, baja).</p>
          </div>

          <p class="muted small-print">La aplicación únicamente solicita acceso de lectura a tu Google Calendar.</p>
        </section>
      </div>
    </section>
  </main>

  <script src="hours-calculation.js"></script>
  <script src="main.js"></script>
</body>
</html>
