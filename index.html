<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Semanal de Sesiones</title>
  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{
      --bg:#0b1020; --card:#111634; --muted:#7d86b2; --text:#eef1ff; --accent:#7aa2ff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji"; background:linear-gradient(180deg,#0b1020,#0b1020 60%,#0d1330); color:var(--text)}
    header{display:flex; align-items:center; justify-content:space-between; padding:16px 20px; position:sticky; top:0; backdrop-filter: blur(8px); background:#0b1020cc; border-bottom:1px solid #1b224a}
    .title{font-weight:800; letter-spacing:.3px}
    .title small{display:block; font-weight:500; color:var(--muted)}
    main{max-width:1100px; margin:24px auto; padding:0 16px 40px}

    .grid{display:grid; gap:16px}
    @media(min-width:1050px){ .grid{grid-template-columns: 2fr 1fr} }

    .card{background:var(--card); border:1px solid #1b224a; border-radius:18px; padding:16px; box-shadow: 0 10px 30px #00000040}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .row > *{margin:4px 0}
    button, input, select{background:#0f1540; color:var(--text); border:1px solid #222b5a; border-radius:12px; padding:10px 12px; font-weight:600}
    button{cursor:pointer; transition:.2s transform}
    button:hover{transform: translateY(-1px)}
    .btn-primary{background:var(--accent); border-color: transparent; color:#0b1020}
    .btn-ghost{background:transparent}

    .stat{background:#0f1540; border:1px solid #1b224a; border-radius:14px; padding:12px 14px; min-width:140px}
    .stat .label{color:var(--muted); font-size:12px}
    .stat .value{font-size:22px; font-weight:800;}
    .muted{color:var(--muted)}

    .progress{height:14px; background:#0f1540; border:1px solid #1b224a; border-radius:999px; overflow:hidden}
    .progress > span{display:block; height:100%; background:linear-gradient(90deg, var(--ok), var(--accent)); width:0}

    table{width:100%; border-collapse: collapse; font-size:14px}
    th, td{padding:10px 8px; border-bottom:1px solid #1b224a}
    th{color:var(--muted); text-align:left; font-weight:600}
    tbody tr:hover{background:#0e1440}

    .pill{font-size:12px; font-weight:700; padding:4px 8px; border-radius:999px; border:1px solid #1b224a}
    .pill.green{background:#10391f; border-color:#1d6a37}
    .pill.orange{background:#3a2d12; border-color:#6b4f1a}
    .pill.cyan{background:#103749; border-color:#165b7a}
    .pill.purple{background:#2a1e44; border-color:#4c3c7a}
    .pill.red{background:#3b1216; border-color:#6d1f28}

    details summary{cursor:pointer; color:var(--muted)}
    .footer{margin-top:20px; color:var(--muted); font-size:12px}
    .k{color:#b6c3ff}
    .warn{color:var(--warn)}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div>Panel semanal de sesiones</div>
      <small id="week-label">Semana actual</small>
    </div>
    <div class="row">
      <input id="clientId" placeholder="Google OAuth CLIENT_ID" size="34"/>
      <button id="signin" class="btn-primary">Conectar Google Calendar</button>
      <button id="refresh" class="btn-ghost" title="Volver a cargar">↻</button>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- Columna izquierda: Resumen y tabla -->
      <section class="card">
        <h3 style="margin:0 0 12px">Resumen semanal</h3>
        <div class="row" id="stats">
          <div class="stat">
            <div class="label">Sesiones dadas (45')</div>
            <div class="value" id="stat-dadas">–</div>
          </div>
          <div class="stat">
            <div class="label">Ausencias</div>
            <div class="value" id="stat-ausencias">–</div>
          </div>
          <div class="stat">
            <div class="label">CAIT Gines</div>
            <div class="value" id="stat-gines">–</div>
          </div>
          <div class="stat">
            <div class="label">CAIT Bormujos</div>
            <div class="value" id="stat-bormujos">–</div>
          </div>
          <div class="stat">
            <div class="label">Privado (P)</div>
            <div class="value" id="stat-privado">–</div>
          </div>
          <div class="stat">
            <div class="label">Otros eventos</div>
            <div class="value" id="stat-otros">–</div>
          </div>
        </div>
        <div style="margin:14px 0 6px" class="muted">Ocupación (min de sesiones dadas / minutos de horario)</div>
        <div class="progress"><span id="progress-bar"></span></div>
        <div class="row" style="justify-content:space-between">
          <div class="muted"><span id="minutes-label">– / – min</span></div>
          <div class="muted"><strong id="pct-label">0%</strong></div>
        </div>

        <div style="border-top:1px solid #1b224a; margin:18px 0 12px"></div>
        <div class="muted" style="font-weight:600; text-transform:uppercase; font-size:12px">Resumen mensual</div>
        <div class="row" style="margin-top:12px" id="month-stats">
          <div class="stat">
            <div class="label">Sesiones mes</div>
            <div class="value" id="stat-month-total">–</div>
          </div>
          <div class="stat">
            <div class="label">Dadas mes</div>
            <div class="value" id="stat-month-dadas">–</div>
          </div>
          <div class="stat">
            <div class="label">Ausencias mes</div>
            <div class="value" id="stat-month-ausencias">–</div>
          </div>
          <div class="stat">
            <div class="label">% dadas</div>
            <div class="value" id="stat-month-pct">–</div>
          </div>
        </div>
        <div class="muted" id="month-label">—</div>
      </section>

      <!-- Columna derecha: Configuración -->
      <aside class="card">
        <h3 style="margin:0 0 12px">Configuración</h3>
        <label class="muted">Minutos de horario por semana (por defecto 38.5h → 2310 min)</label>
        <div class="row">
          <input id="cfg-minutes" type="number" min="0" step="15" value="2310" />
          <button id="save-cfg">Guardar</button>
        </div>

        <details style="margin-top:12px">
          <summary>Reglas (hechas a tu sistema)</summary>
<pre style="white-space:pre-wrap; background:#0f1540; border:1px solid #1b224a; border-radius:12px; padding:10px; overflow:auto"><code id="rules-json" contenteditable="true">{
  "centros": {
    "gines": ["(g)"],
    "bormujos": ["(b)"],
    "privado": ["(p)"]
  },
  "pattern_sesion": "^\*?\s*(\d{3,6})\s+(.+?)\s*\(([BGP])\)\s*$",
  "otros_excluir_totalmente": [
    "^g\s*:\s*\d+$", "^b\s*:\s*\d+$", "^ent\.\s*[bg]\s*:\s*\d+"
  ],
  "bloques_horario": [
    "^[bg]\s*\d{1,2}$"
  ],
  "otros_keywords": ["firma","comida","coordinación","reunión","formación","llamada","administrativo","battelle"]
}</code></pre>
          <div class="row" style="margin-top:8px">
            <button id="save-rules">Guardar reglas</button>
            <button id="reset-rules" class="btn-ghost">Restaurar por defecto</button>
          </div>
          <div class="muted">* Si un título empieza por <strong>*</strong> antes del NH, se cuenta como <strong>ausencia</strong> (no suma a dadas).</div>
        </details>

        <p class="footer">1) Crea un <strong>OAuth 2.0 Client ID</strong> (Web) y pega el <em>Client ID</em>. 2) Autoriza el scope <code>https://www.googleapis.com/auth/calendar.readonly</code>. 3) La app solo lee el calendario <strong>Andrea LG</strong> por defecto (puedes cambiarlo en el selector).</p>
      </aside>
    </div>

    <section class="card" style="margin-top:16px">
      <div class="row" style="justify-content:space-between; align-items:end; flex-wrap:wrap; gap:12px">
        <div>
          <h3 style="margin:0">Eventos de la semana</h3>
          <div class="muted" id="range-label">—</div>
        </div>
        <div class="row" style="gap:8px; flex-wrap:wrap">
          <select id="calendar-select"></select>
          <button id="load-week">Cargar semana</button>
        </div>
      </div>

      <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:12px">
        <button id="prev-week" class="btn-ghost" title="Semana anterior">◀</button>
        <input id="week-picker" type="date" />
        <button id="next-week" class="btn-ghost" title="Semana siguiente">▶</button>
        <button id="today-week" class="btn-ghost">Semana actual</button>
      </div>

      <div style="overflow:auto; margin-top:8px">
        <table id="events-table">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Título</th>
              <th>Centro</th>
              <th>Estado</th>
              <th>Tipo</th>
              <th>Duración</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ======== UTILIDADES DE TIEMPO (Semana Lunes-Domingo en Europe/Madrid) ========
    const TZ = 'Europe/Madrid';
    const fmtDate = (d)=> d.toLocaleDateString('es-ES', { timeZone: TZ });
    const fmtTime = (d)=> d.toLocaleTimeString('es-ES', { timeZone: TZ, hour:'2-digit', minute:'2-digit' });
    const fmtMonthYear = (d)=> d.toLocaleDateString('es-ES', { timeZone: TZ, month: 'long', year: 'numeric' });

    function getWeekRange(baseDate=new Date()){
      const d = new Date(baseDate);
      const day = (d.getDay() + 6) % 7; // 0..6 con 0 = lunes
      const start = new Date(d);
      start.setHours(0,0,0,0);
      start.setDate(d.getDate() - day);
      const end = new Date(start);
      end.setDate(start.getDate() + 7);
      return {start, end};
    }

    function getMonthRange(baseDate=new Date()){
      const d = new Date(baseDate);
      d.setHours(0,0,0,0);
      d.setDate(1);
      const start = new Date(d);
      const end = new Date(start);
      end.setMonth(end.getMonth() + 1);
      return {start, end};
    }

    // ======== ESTADO Y PERSISTENCIA ========
    const $ = (sel)=> document.querySelector(sel);
    const cfg = {
      minutesAvailable: Number(localStorage.getItem('minutesAvailable') || 2310),
      rules: JSON.parse(localStorage.getItem('rules') || '{}'),
      clientId: localStorage.getItem('clientId') || ''
    };

    const weekPicker = $('#week-picker');
    const monthTotalEl = $('#stat-month-total');
    const monthDadasEl = $('#stat-month-dadas');
    const monthAusenciasEl = $('#stat-month-ausencias');
    const monthPctEl = $('#stat-month-pct');
    const monthLabelEl = $('#month-label');

    const FALLBACK_SESSION_REGEX = /^\*?\s*(\d{3,6})\s+(.+?)\s*\(([BGP])\)\s*$/i;

    const DEFAULT_RULES = {
      centros: { gines:["(g)"], bormujos:["(b)"], privado:["(p)"] },
      pattern_sesion: FALLBACK_SESSION_REGEX.source,
      otros_excluir_totalmente: ["^g\s*:\s*\d+$","^b\s*:\s*\d+$","^ent\.\s*[bg]\s*:\s*\d+"],
      bloques_horario: ["^[bg]\s*\d{1,2}$"],
      otros_keywords: ["firma","comida","coordinación","reunión","formación","llamada","administrativo","battelle"]
    };

    const DEFAULT_SESSION_REGEX = (()=>{
      try{
        return buildRegex(DEFAULT_RULES.pattern_sesion);
      }catch(err){
        console.error('pattern_sesion por defecto inválido, usando comodín', err);
        return FALLBACK_SESSION_REGEX;
      }
    })();

    function formatDateInputValue(date){
      const d = new Date(date);
      if(Number.isNaN(d.getTime())) return '';
      const offset = d.getTimezoneOffset();
      const local = new Date(d.getTime() - offset * 60000);
      return local.toISOString().slice(0, 10);
    }

    function parseDateInputValue(value){
      if(!value) return null;
      const parts = value.split('-').map(Number);
      if(parts.length !== 3) return null;
      const [year, month, day] = parts;
      if(!year || !month || !day) return null;
      return new Date(year, month - 1, day);
    }

    function formatMonthRangeText(range){
      const end = new Date(range.end - 1);
      return `Mes de ${fmtMonthYear(range.start)} (${fmtDate(range.start)} - ${fmtDate(end)})`;
    }

    let week = null;
    let weekRequestToken = 0;
    let monthSummaryToken = 0;

    function updateWeekUI(){
      if(!week) return;
      const start = week.start;
      const end = new Date(week.end - 1);
      $('#week-label').textContent = `Del ${fmtDate(start)} al ${fmtDate(end)}`;
      $('#range-label').textContent = `Consultando de ${fmtDate(start)} 00:00 a ${fmtDate(end)} 23:59 (${TZ})`;
      if(weekPicker){ weekPicker.value = formatDateInputValue(start); }
    }

    function setWeekFromDate(baseDate){
      if(!(baseDate instanceof Date) || Number.isNaN(baseDate.getTime())) return;
      const newWeek = getWeekRange(baseDate);
      if(week && week.start.getTime() === newWeek.start.getTime()){ // sin cambios reales
        week = newWeek;
        updateWeekUI();
        return;
      }
      week = newWeek;
      updateWeekUI();
      monthSummaryToken++;
      resetMonthSummary();
      if(accessToken){ loadWeek(); }
    }

    function changeWeekBy(days){
      if(!week) return;
      const base = new Date(week.start);
      base.setDate(base.getDate() + days);
      setWeekFromDate(base);
    }

    function resetMonthSummary(text='—'){
      monthTotalEl.textContent = '–';
      monthDadasEl.textContent = '–';
      monthAusenciasEl.textContent = '–';
      monthPctEl.textContent = '–';
      monthLabelEl.textContent = text;
    }

    function setMonthSummaryLoading(range){
      monthTotalEl.textContent = '…';
      monthDadasEl.textContent = '…';
      monthAusenciasEl.textContent = '…';
      monthPctEl.textContent = '…';
      monthLabelEl.textContent = range ? `Cargando ${formatMonthRangeText(range)}...` : 'Cargando resumen mensual...';
    }

    function cloneRules(rules){
      return JSON.parse(JSON.stringify(rules));
    }

    if(!cfg.rules || !cfg.rules.centros){ cfg.rules = cloneRules(DEFAULT_RULES); }

    $('#cfg-minutes').value = cfg.minutesAvailable;
    $('#clientId').value = cfg.clientId;
    $('#rules-json').textContent = JSON.stringify(cfg.rules, null, 2);

    week = getWeekRange();
    updateWeekUI();
    resetMonthSummary();

    // ======== AUTH (GIS Token Client) ========
    let tokenClient = null; let accessToken = null; let calendars = [];

    function initTokenClient(){
      const clientId = $('#clientId').value.trim();
      if(!clientId){ alert('Introduce tu Google OAuth CLIENT_ID'); return; }
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: 'https://www.googleapis.com/auth/calendar.readonly',
        prompt: '',
        callback: (resp)=>{
          if(resp && resp.access_token){ accessToken = resp.access_token; loadCalendars(); }
          else alert('No se obtuvo access_token');
        }
      });
    }

    async function loadCalendars(){
      try{
        const res = await fetch('https://www.googleapis.com/calendar/v3/users/me/calendarList', {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        if(!res.ok){
          const msg = await res.text();
          throw new Error(`Error cargando calendarios (${res.status}): ${msg}`);
        }
        const data = await res.json();
        calendars = data.items || [];
        const sel = $('#calendar-select');
        sel.innerHTML = '';
        calendars.forEach(c=>{
          const opt = document.createElement('option');
          opt.value = c.id; opt.textContent = c.summary; sel.appendChild(opt);
        });
        // Autoseleccionar "Andrea LG" si existe
        const lg = calendars.find(c=> (c.summary||'').toLowerCase().includes('andrea lg'));
        if(lg){ sel.value = lg.id; }
        if(calendars.length){ loadWeek(); }
      }catch(err){
        console.error(err);
        alert('No se pudieron cargar los calendarios. Revisa la consola para más detalles.');
      }
    }

    // ======== CLASIFICACIÓN ========
    function textFromEvent(ev){
      return [ev.summary||'', ev.location||'', (ev.description||'')].join(' ').toLowerCase().trim();
    }
    const REGEX_CACHE = new Map();

    function compilePattern(pattern){
      const key = String(pattern ?? '');
      if(REGEX_CACHE.has(key)) return REGEX_CACHE.get(key);
      try{
        const regex = buildRegex(key);
        REGEX_CACHE.set(key, regex);
        return regex;
      }catch(err){
        console.warn('Patrón inválido ignorado', pattern, err);
        REGEX_CACHE.set(key, null);
        return null;
      }
    }

    function matchesPattern(text, pattern){
      if(!pattern) return false;
      const regex = compilePattern(pattern);
      if(regex) return regex.test(text);
      const normalized = (text||'').toLowerCase();
      return normalized.includes(String(pattern).toLowerCase());
    }
    function matchesAnyRegex(text, regexList){
      return (regexList||[]).some(p=> matchesPattern(text, p));
    }
    function detectCentroFromRules(text){
      const centros = cfg.rules.centros || {};
      const lower = text.toLowerCase();
      for(const [centro, patterns] of Object.entries(centros)){
        if(matchesAnyRegex(lower, patterns)) return centro;
      }
      return null;
    }

    const SESSION_REGEX_CACHE = { pattern: null, regex: DEFAULT_SESSION_REGEX };

    function buildRegex(pattern){
      const trimmed = pattern.trim();
      if(!trimmed){
        throw new Error('empty pattern');
      }
      if(trimmed.startsWith('/') && trimmed.lastIndexOf('/') > 0){
        const lastSlash = trimmed.lastIndexOf('/');
        const source = trimmed.slice(1, lastSlash);
        const flags = trimmed.slice(lastSlash + 1) || 'i';
        const normalizedFlags = flags.includes('i') ? flags : flags + 'i';
        return new RegExp(source, normalizedFlags);
      }
      return new RegExp(trimmed, 'i');
    }

    function safeSessionRegex(){
      const pattern = typeof cfg.rules.pattern_sesion === 'string' ? cfg.rules.pattern_sesion : '';
      if(pattern === SESSION_REGEX_CACHE.pattern && SESSION_REGEX_CACHE.regex){
        return SESSION_REGEX_CACHE.regex;
      }
      if(pattern.trim()){
        try{
          const regex = buildRegex(pattern);
          SESSION_REGEX_CACHE.pattern = pattern;
          SESSION_REGEX_CACHE.regex = regex;
          return regex;
        }catch(err){
          console.warn('pattern_sesion inválido, usando defecto', err);
        }
      }
      SESSION_REGEX_CACHE.pattern = pattern;
      SESSION_REGEX_CACHE.regex = DEFAULT_SESSION_REGEX;
      return DEFAULT_SESSION_REGEX;
    }

    function sessionParse(ev){
      const title = (ev.summary||'').trim();
      const cleaned = title.replace(/^\*/, '').trim();
      const regex = safeSessionRegex();
      const m = cleaned.match(regex);
      if(m){
        const absent = /^\*/.test(title.trim());
        const nh = m[1];
        const nombre = m[2];
        const letra = (m[3]||'').toUpperCase();
        const centro = centroFromLetra(letra) || detectCentroFromRules(cleaned) || '—';
        return {nh, nombre, centro, absent};
      }

      const centroFallback = detectCentroFromRules(cleaned);
      if(!centroFallback) return null;
      const nhFallback = cleaned.match(/\b\d{3,6}\b/);
      if(!nhFallback) return null;
      const absent = /^\*/.test(title.trim());
      const nhText = nhFallback[0];
      const nhIndex = typeof nhFallback.index === 'number' ? nhFallback.index : cleaned.indexOf(nhText);
      const nombre = cleaned
        .slice(nhIndex + nhText.length)
        .replace(/\([^)]*\).*/, '')
        .replace(/[-–:]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
      return {nh: nhText, nombre, centro: centroFallback, absent};
    }
    function isBloqueHorario(ev){
      const t = (ev.summary||'').trim();
      return matchesAnyRegex(t, cfg.rules.bloques_horario||[]);
    }
    function isExcluirTotal(ev){
      const t = (ev.summary||'').trim();
      return matchesAnyRegex(t, cfg.rules.otros_excluir_totalmente||[]);
    }
    function isOtroPorKeyword(ev){
      const t = textFromEvent(ev);
      return (cfg.rules.otros_keywords||[]).some(k=> t.includes(k.toLowerCase()));
    }
    function durationMinutes(ev){
      const start = new Date(ev.start.dateTime || (ev.start.date + 'T00:00:00'));
      const end = new Date(ev.end.dateTime || (ev.end.date + 'T23:59:59'));
      return Math.max(0, Math.round((end - start)/60000));
    }

    function centroFromLetra(letra){
      if(letra==='G') return 'gines';
      if(letra==='B') return 'bormujos';
      if(letra==='P') return 'privado';
      return null;
    }

    function renderMonthSummary(events, range){
      let dadas = 0;
      let ausencias = 0;

      events.forEach(ev=>{
        if(isExcluirTotal(ev)) return;
        const sp = sessionParse(ev);
        if(!sp) return;
        if(sp.absent) ausencias++;
        else dadas++;
      });

      const total = dadas + ausencias;
      monthTotalEl.textContent = String(total);
      monthDadasEl.textContent = String(dadas);
      monthAusenciasEl.textContent = String(ausencias);
      monthPctEl.textContent = total>0 ? `${Math.round((dadas/total)*100)}%` : '–';
      monthLabelEl.textContent = formatMonthRangeText(range);
    }

    // ======== CARGA DE EVENTOS ========
    async function fetchEventsForRange(calId, range){
      const params = new URLSearchParams({
        singleEvents: 'true', orderBy: 'startTime', timeZone: TZ,
        timeMin: range.start.toISOString(), timeMax: range.end.toISOString(), maxResults: '2500'
      });
      const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(calId)}/events?${params.toString()}`;
      const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` }});
      if(!res.ok){
        const msg = await res.text();
        throw new Error(`Error cargando eventos (${res.status}): ${msg}`);
      }
      const data = await res.json();
      return (data.items||[]).filter(e=> !e.status || e.status!=='cancelled');
    }

    async function loadMonthSummary(calId){
      if(!week) return;
      const monthRange = getMonthRange(week.start);
      const token = ++monthSummaryToken;
      setMonthSummaryLoading(monthRange);
      try{
        const events = await fetchEventsForRange(calId, monthRange);
        if(token !== monthSummaryToken) return;
        renderMonthSummary(events, monthRange);
      }catch(err){
        if(token === monthSummaryToken){
          console.error(err);
          resetMonthSummary('No se pudo cargar el resumen mensual.');
        }
      }
    }

    async function loadWeek(){
      const calId = $('#calendar-select').value || 'primary';
      monthSummaryToken++;
      if(week){
        setMonthSummaryLoading(getMonthRange(week.start));
      }
      const token = ++weekRequestToken;
      try{
        const events = await fetchEventsForRange(calId, week);
        if(token !== weekRequestToken) return;
        render(events);
      }catch(err){
        if(token === weekRequestToken){
          console.error(err);
          alert('No se pudieron cargar los eventos de la semana. Revisa la consola para más detalles.');
          resetMonthSummary();
        }
        return;
      }
      if(token === weekRequestToken){
        loadMonthSummary(calId);
      }
    }

    // ======== RENDER ========
    function render(events){
      const tbody = $('#events-table tbody');
      tbody.innerHTML = '';

      let dadas=0, ausencias=0, otros=0, gines=0, bormujos=0, privado=0;
      let minutosSesionDadas = 0; // siempre 45' por sesión dada

      events.forEach(ev=>{
        const title = (ev.summary||'').trim();
        if(isExcluirTotal(ev)) return; // ni contar ni listar

        const start = new Date(ev.start.dateTime || (ev.start.date + 'T00:00:00'));
        const end   = new Date(ev.end.dateTime   || (ev.end.date   + 'T23:59:59'));
        const mins  = durationMinutes(ev);

        let tipo='otro';
        let estado='—';
        let centro='—';

        const sp = sessionParse(ev);
        if(sp){
          tipo = 'sesión';
          estado = sp.absent ? 'ausencia' : 'dada';
          centro = sp.centro || '—';
          if(sp.absent){
            ausencias++;
          }else{
            dadas++;
            minutosSesionDadas += 45; // fijo por requerimiento
            if(centro==='gines') gines++;
            else if(centro==='bormujos') bormujos++;
            else if(centro==='privado') privado++;
          }
        }else if(isBloqueHorario(ev)){
          tipo = 'bloque';
          estado = '—';
        }else if(isOtroPorKeyword(ev)){
          tipo = 'otro';
          otros++;
        }else{
          // Si no encaja en nada, lo marcamos como otros, pero lo listamos
          tipo = 'otro';
          otros++;
        }

        const centroPillClass = centro==='gines' ? 'green' : centro==='bormujos' ? 'orange' : centro==='privado' ? 'purple' : 'cyan';
        const estadoPillClass = estado==='dada' ? 'green' : estado==='ausencia' ? 'red' : 'cyan';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(start)}</td>
          <td>${ev.start.date ? '—' : fmtTime(start)}</td>
          <td>${ev.end.date ? '—' : fmtTime(end)}</td>
          <td>${title || '<span class="muted">(sin título)</span>'}</td>
          <td><span class="pill ${centroPillClass}">${centro}</span></td>
          <td><span class="pill ${estadoPillClass}">${estado}</span></td>
          <td>${tipo}</td>
          <td>${mins} min</td>`;
        tbody.appendChild(tr);
      });

      if(!tbody.children.length){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="8" class="muted">No hay eventos que mostrar con las reglas actuales.</td>`;
        tbody.appendChild(tr);
      }

      // Estadísticas
      $('#stat-dadas').textContent = String(dadas);
      $('#stat-ausencias').textContent = String(ausencias);
      $('#stat-otros').textContent = String(otros);
      $('#stat-gines').textContent = String(gines);
      $('#stat-bormujos').textContent = String(bormujos);
      $('#stat-privado').textContent = String(privado);

      const available = Number(cfg.minutesAvailable)||0; // por defecto 2310 (38.5h)
      const pct = available>0 ? Math.min(100, Math.round((minutosSesionDadas/available)*100)) : 0;
      $('#minutes-label').textContent = `${minutosSesionDadas} / ${available} min`;
      $('#pct-label').textContent = `${pct}%`;
      $('#progress-bar').style.width = pct + '%';
    }

    // ======== EVENTOS UI ========
    $('#signin').addEventListener('click', ()=>{
      localStorage.setItem('clientId', $('#clientId').value.trim());
      initTokenClient();
      tokenClient?.requestAccessToken();
    });

    $('#refresh').addEventListener('click', ()=>{
      if(accessToken){
        loadCalendars();
      }else{
        initTokenClient();
        tokenClient?.requestAccessToken();
      }
    });
    $('#load-week').addEventListener('click', ()=>{ if(!accessToken) return alert('Conéctate primero'); loadWeek(); });
    $('#prev-week')?.addEventListener('click', ()=> changeWeekBy(-7));
    $('#next-week')?.addEventListener('click', ()=> changeWeekBy(7));
    $('#today-week')?.addEventListener('click', ()=> setWeekFromDate(new Date()));
    weekPicker?.addEventListener('change', (event)=>{
      const value = event.target.value;
      const date = parseDateInputValue(value);
      if(date) setWeekFromDate(date);
    });

    $('#save-cfg').addEventListener('click', ()=>{
      const m = Number($('#cfg-minutes').value||0);
      cfg.minutesAvailable = m; localStorage.setItem('minutesAvailable', String(m));
      if($('#events-table tbody').children.length) $('#refresh').click();
    });

    $('#save-rules').addEventListener('click', ()=>{
      try{
        const json = JSON.parse($('#rules-json').textContent);
        cfg.rules = json; localStorage.setItem('rules', JSON.stringify(json));
        alert('Reglas guardadas. Recarga la semana para aplicar cambios.');
      }catch(e){ alert('JSON inválido en las reglas'); }
    });

    $('#reset-rules').addEventListener('click', ()=>{
      cfg.rules = cloneRules(DEFAULT_RULES);
      $('#rules-json').textContent = JSON.stringify(cfg.rules, null, 2);
      localStorage.removeItem('rules');
      alert('Reglas restauradas. Recarga la semana para aplicar cambios.');
    });

    // Silenciar errores causados por extensiones de navegador que cierran canales de mensaje
    window.addEventListener('unhandledrejection', (event)=>{
      const msg = event?.reason?.message || '';
      if(typeof msg === 'string' && msg.includes('message channel closed before a response was received')){
        event.preventDefault();
        console.warn('Ignorando error externo del canal de mensajes:', event.reason);
      }
    });

    // Autocarga si ya hay token en memoria del navegador (GIS puede reutilizar sesión)
    window.addEventListener('load', ()=>{
      if(cfg.clientId){ initTokenClient(); }
    });
  </script>
</body>
</html>
